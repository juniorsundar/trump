name: Release Static Binary

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0.0, v0.2.1-rc1, etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to upload assets to releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: juniorsundar
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'      # Optional: Add caching here (see note below) to speed up builds significantly

      - name: Build Static Binary
        run: nix build .#static

      - name: Prepare Binary for Release
        run: |
          # Nix builds result in a symlink called 'result'
          # We resolve it and copy the binary out to rename it clearly
          
          # Replace 'trump' with your actual binary name if different
          BINARY_NAME="trump" 
          
          cp result/bin/$BINARY_NAME $BINARY_NAME-x86_64-linux-musl
          
          # Verify it's actually static (optional, for logs)
          file $BINARY_NAME-x86_64-linux-musl

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            trump-x86_64-linux-musl
          draft: true       # Set to false if you want auto-publishing
          prerelease: false