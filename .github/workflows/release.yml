name: Release Static Binary

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0.0, v0.2.1-rc1, etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to upload assets to releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: juniorsundar
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'      # Optional: Add caching here (see note below) to speed up builds significantly

      - name: Build Static Binary
        run: |
          # Build x86_64
          nix build .#static --accept-flake-config
          cp result/bin/trump trump-x86_64-linux-musl

          # Build aarch64
          nix build .#static-aarch64 --accept-flake-config
          cp result/bin/trump trump-aarch64-linux-musl

      - name: Prepare Binary for Release
        run: |
          # Verify it's actually static (optional, for logs)
          file trump-x86_64-linux-musl
          file trump-aarch64-linux-musl

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            trump-x86_64-linux-musl
            trump-aarch64-linux-musl
          draft: true       # Set to false if you want auto-publishing
          prerelease: false